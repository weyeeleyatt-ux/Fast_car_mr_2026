-- ===== CAPTAINS =====
create table if not exists public.captains (
  id uuid primary key default gen_random_uuid(),
  created_at timestamptz not null default now(),

  code text unique not null,           -- الكود اللي يعطيه الكابتن للإدارة
  full_name text not null,
  phone text unique not null,
  pass text not null,                  -- كلمة سر الكابتن (بسيطة للتجربة)

  points integer not null default 0    -- رصيد النقاط
);

-- ===== TRIPS =====
create table if not exists public.trips (
  id uuid primary key default gen_random_uuid(),
  created_at timestamptz not null default now(),

  customer_name text not null,
  customer_phone text not null,

  pickup_text text not null,
  dropoff_text text not null,

  pickup_lat double precision,
  pickup_lng double precision,
  dropoff_lat double precision,
  dropoff_lng double precision,

  distance_km double precision,
  price_old integer not null default 900,

  status text not null default 'متوفر',   -- متوفر/مقبول/مرفوض/بدأ/انتهى
  note text,

  captain_id uuid references public.captains(id),
  captain_name text
);

-- ===== POINTS TRANSACTIONS (شحن/خصم) =====
create table if not exists public.points_tx (
  id uuid primary key default gen_random_uuid(),
  created_at timestamptz not null default now(),

  captain_id uuid not null references public.captains(id) on delete cascade,
  type text not null,          -- topup / fee
  amount integer not null,     -- + أو -
  note text
);

-- ===== RLS (مفتوح للتجربة) =====
alter table public.captains enable row level security;
alter table public.trips enable row level security;
alter table public.points_tx enable row level security;

drop policy if exists "captains_all" on public.captains;
create policy "captains_all" on public.captains for all to anon using (true) with check (true);

drop policy if exists "trips_all" on public.trips;
create policy "trips_all" on public.trips for all to anon using (true) with check (true);

drop policy if exists "points_all" on public.points_tx;
create policy "points_all" on public.points_tx for all to anon using (true) with check (true);
